<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>
        <input type="date" id="txtStartDate">
        <input type="time" id="txtStartTime">
    </div>
    <div>
        <input type="date" id="txtEndDate">
        <input type="time" id="txtEndTime">
    </div>
    <div class="loginBtnArea2">
        <p>
            <b><input type=button name=cmdNew alt='시간자동계산' value="시간자동계산" onclick="javascript:
    fn_autoCalculation();">
                <asp:button ID="Button2" style="display:none" runat="server" OnClientClick="fn_Clear(); return false;"
                    alt='시간자동계산' Text="시간자동계산" />
            </b>
        </p>
    </div>
    <div style="height:5px"></div>
    <table width="1000" border="0" cellspacing="0" id="tbLogin" class="dataTbl">
        <tr>
            <th class="whPx30 table_fixedHeader" style="text-align:left">연장(1.5x)</th>
            <td class="whPx20 table_fixedHeader" style="text-align:left">
                <input size="4" id="txtAOtReq15" name="txtAOtReq15">
            </td>
            <th class="whPx30 table_fixedHeader" style="text-align:left">야간(0.5x)</th>
            <td class="whPx20 table_fixedHeader" style="text-align:left">
                <input size="4" id="txtAOtReq05" name="txtAOtReq05">
            <th class="whPx30 table_fixedHeader" style="text-align:left">휴일할증(0.5x)</th>
            <td class="whPx20 table_fixedHeader" style="text-align:left">
                <input size="4" id="txtAOtReqPlus" name="txtAOtReqPlus">
            </td>
            <th class="whPx30 table_fixedHeader" style="text-align:left">총</th>
            <td class="whPx20 table_fixedHeader" style="text-align:left">
                <input size="8" id="txtAOtTotalTime" name="txtAOtTotalTime" disabled>
            </td>

        </tr>
    </table>
</body>
<script>
    var holyList = ["0815", "0928", "0929", "0930", "1003", "1009", "1225"]; //광복절
    function fn_autoCalculation() {

        //연장시간 구하기
        var sAOtReq15StartTimeF =
            document.getElementById("txtStartDate").value + " " +
            document.getElementById("txtStartTime").value + ":00";
        var sDateAOtReq15StartTime = new Date(sAOtReq15StartTimeF);
        var sAOtReq15EndTimeF =
            document.getElementById("txtEndDate").value + " " +
            document.getElementById("txtEndTime").value + ":00";
        var sDateAOtReq15EndTime = new Date(sAOtReq15EndTimeF);

        console.log("st", sDateAOtReq15StartTime);
        console.log("et", sDateAOtReq15EndTime);

        var sFinalAOtReq15 = (sDateAOtReq15StartTime.getTime() -
            sDateAOtReq15EndTime.getTime()) / (1000 * 60 * 60);

        var workFinalAOtReq15 = Math.abs(Number(sFinalAOtReq15).toFixed(2));

        if (0 <= workFinalAOtReq15 && workFinalAOtReq15 <= 4) {
            document.getElementById("txtAOtReq15").value =
                workFinalAOtReq15;
        } else if (4 < workFinalAOtReq15 && workFinalAOtReq15 <= 8.5) {
            document.getElementById("txtAOtReq15").value =
                (workFinalAOtReq15 - 0.50);
        } else if (8.5 < workFinalAOtReq15 && workFinalAOtReq15 <= 13) {
            document.getElementById("txtAOtReq15").value =
                (workFinalAOtReq15 - 1.00);
        } else if (13 < workFinalAOtReq15 && workFinalAOtReq15 <= 17.5) {
            document.getElementById("txtAOtReq15").value =
                (workFinalAOtReq15 - 1.50);
        } else {
            document.getElementById("txtAOtReq15").value = "0.00";
        }

        //document.getElementById("txtAOtReq15").value =
        Math.abs(Number(sFinalAOtReq15).toFixed(2));

        // 시작 날짜, 시간
        var sAOtReq15StartDate =
            document.getElementById("txtStartDate").value;
        var sAOtReq15StartTime =
            document.getElementById("txtStartTime").value;

        // 종료 날짜, 시간
        var sAOtReq15EndDate = document.getElementById("txtEndDate").value;
        var sAOtReq15EndTime = document.getElementById("txtEndTime").value;

        var workStartDate = new Date(sAOtReq15StartDate);
        var workEndDate = new Date(sAOtReq15EndDate);

        // console.log(sAOtReq15EndTime);

        // 일수 차이 계산
        var timeDiff = workEndDate.getTime() - workStartDate.getTime();
        var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

        // 일한시간을 배열로 계산
        var workArray = new Array(diffDays + 1);
        // 시작 ~ 종료 -> 당일 치기 계산
        if (diffDays === 0) {
            workArray[0] = new Array(24).fill(0);
            for (var time = 0; time < 24; time++) {

                // 시작시간
                if (time === Number(sAOtReq15StartTime.split(":")[0])) {
                    workArray[0][time] = 60 -
                        Number(sAOtReq15StartTime.split(":")[1]);
                }

                /*
                // fix -- before
                if (time === Number(sAOtReq15EndTime.split(":")[0])) {
                    workArray[0][time] = Number(sAOtReq15EndTime.split(":")[1]);
                }
                */

                // fix -- after
                // 종료시간
                
                if (time === Number(sAOtReq15EndTime.split(":")[0])) {
                    workArray[0][time] = Number(sAOtReq15EndTime.split(":")[1]);
                }

                // 시작시간과 종료시간이 같은경우,
                if (Number(sAOtReq15StartTime.split(":")[0]) == time 
                    && time == Number(sAOtReq15EndTime.split(":")[0])) {
                        workArray[0][time] = Number(sAOtReq15EndTime.split(":")[1]) - Number(sAOtReq15StartTime.split(":")[1]);
                }
                // fix end

                // etc..
                if (Number(sAOtReq15StartTime.split(":")[0]) < time
                    && time < Number(sAOtReq15EndTime.split(":")[0])) {
                    workArray[0][time] = 60;
                }
            }
        } else {

            for (var day = 0; day <= diffDays; day++) {
                // 하루는 24시간
                if (day === 0) {
                    workArray[day] = new Array(24).fill(0);
                    for (var time =
                        Number(sAOtReq15StartTime.split(":")[0]); time < 24; time++) {
                        if (time === Number(sAOtReq15StartTime.split(":")[0])) {
                            workArray[day][time] = 60 -
                                Number(sAOtReq15StartTime.split(":")[1]);
                        } else {
                            workArray[day][time] = 60;
                        }
                    }
                }
                if (day === diffDays) {
                    workArray[day] = new Array(24).fill(0);
                    for (var time = 0; time <=
                        Number(sAOtReq15EndTime.split(":")[0]); time++) {
                        if (time === Number(sAOtReq15EndTime.split(":")[0])) {
                            workArray[day][time] =
                                Number(sAOtReq15EndTime.split(":")[1]);
                        } else {
                            workArray[day][time] = 60;
                        }
                    }
                }

                if (day !== 0 && day !== diffDays) {
                    workArray[day] = new Array(24).fill(60);
                }
            }
        }

        var txtAOtReq05 = 0;
        var txtAOtReqPlus = 0;
        //var txtAOtReq15 = document.getElementById("txtAOtReq15").value; // 연장

        for (var day = 0; day <= diffDays; day++) {
            var Req05WorkTime = 0;
            var workTime = 0;
            var curDate = new Date(workStartDate);
            curDate.setDate(workStartDate.getDate() + day);

            for (var hour = 0; hour < 24; hour++) {
                // 하루 총 일한시간
                workTime += workArray[day][hour];
                // 야간 계산 // 22 ~ 6
                if (hour >= 22 || hour < 6) {
                    Req05WorkTime += workArray[day][hour];
                }
            }

            if (isHolyDay(curDate)) {
                // txtAOtReqPlus += workArray[day][hour];
                var workTimePerHour = (workTime / 60).toFixed(2);
                if (0 <= workTimePerHour && workTimePerHour <= 9) {
                    txtAOtReqPlus += 0;
                } else if (9 < workTimePerHour && workTimePerHour <= 13) {
                    txtAOtReqPlus += workFinalAOtReq15 - 9;
                } else if (13 < workTimePerHour && workTimePerHour <= 13.5) {
                    txtAOtReqPlus += 4;
                } else if (13.5 < workTimePerHour && workTimePerHour <= 17.5) {
                    txtAOtReqPlus += workFinalAOtReq15 - 9.5;
                } else {
                    txtAOtReqPlus += 0;
                }
            }

            txtAOtReq05 += Req05WorkTime;

        }
        console.log(workArray)

        if (document.getElementById("txtAOtReq05").value < 1) {
            document.getElementById("txtAOtReq05").value =
                workFinalAOtReq15;
        }

        document.getElementById("txtAOtReq05").value =
            (txtAOtReq05 / 60).toFixed(2);
        document.getElementById("txtAOtReqPlus").value =
            txtAOtReqPlus.toFixed(2);

        if ((txtAOtReq05 / 60).toFixed(2) > 0.50 &&
            workFinalAOtReq15 < 1) {
            document.getElementById("txtAOtReq05").value =
                ((txtAOtReq05 / 60) - 0.5).toFixed(2);
        }

        var sAOtTotalTime =
            (Number(document.getElementById("txtAOtReq15").value) * 1.5 +
                Number(document.getElementById("txtAOtReq05").value) * 0.5 +
                Number(document.getElementById("txtAOtReqPlus").value) *
                0.5).toFixed(2);

        document.getElementById("txtAOtTotalTime").value = sAOtTotalTime;

    }

    // 총 분구하는 계산식
    function getMinute(time) {
        var minute = Number(time[0]) * 60 + Number(time[1]);
        return minute;
    }

    // 휴일 검증 계산식
    function isHolyDay(date) {
        // 공휴일인지 아닌지 계산
        var options = {
            month: '2-digit',
            day: '2-digit'
        };

        var dateFormatter = new Intl.DateTimeFormat('en-US', options);

        // mm/dd -> mmdd
        var formattedDate = dateFormatter.format(date).replace("/", "");

        // 일요일인지 아닌지 계산
        var days = ["일", "월", "화", "수", "목", "금", "토"];

        return holyList.includes(formattedDate) ||
            days[date.getDay()] === "일";
    }
</script>

</html>